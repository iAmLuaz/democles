export async function getRuntimeConfig(): Promise<RuntimeConfig> {
  if (cachedConfig) return cachedConfig

  let res: Response

  try {
    res = await fetch('/api/config')
  } catch (e) {
    console.error('[CONFIG] Network error', e)
    cachedConfig = { apiUrl: null, useMock: true }
    return cachedConfig
  }

  console.log('[CONFIG] status:', res.status)
  console.log('[CONFIG] headers:', [...res.headers.entries()])

  const text = await res.text()
  console.log('[CONFIG] raw response:', text)

  if (!res.ok) {
    cachedConfig = { apiUrl: null, useMock: true }
    return cachedConfig
  }

  try {
    const data = JSON.parse(text)

    cachedConfig = {
      apiUrl: data.API_URL ?? null,
      useMock: Boolean(data.USE_MOCK),
    }

    return cachedConfig
  } catch (e) {
    console.error('[CONFIG] JSON parse failed')
    cachedConfig = { apiUrl: null, useMock: true }
    return cachedConfig
  }
}
