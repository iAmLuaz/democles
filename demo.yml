const {
  StorageSharedKeyCredential,
  generateBlobSASQueryParameters,
  BlobSASPermissions
} = require('@azure/storage-blob')

module.exports = async function (context, req) {
  const filename = req.query.filename

  if (!filename) {
    context.res = { status: 400, body: 'filename required' }
    return
  }

  const accountName = process.env.STORAGE_ACCOUNT_NAME
  const accountKey = process.env.STORAGE_ACCOUNT_KEY

  const credential = new StorageSharedKeyCredential(
    accountName,
    accountKey
  )

  const expiresOn = new Date(Date.now() + 5 * 60 * 1000)

  const sas = generateBlobSASQueryParameters({
    containerName: 'uploads',
    blobName: filename,
    permissions: BlobSASPermissions.parse('cw'),
    expiresOn
  }, credential).toString()

  context.res = {
    status: 200,
    body: {
      uploadUrl: `https://${accountName}.blob.core.windows.net/uploads/${filename}?${sas}`
    }
  }
}
