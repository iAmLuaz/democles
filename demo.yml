async getAll(): Promise<Persona[]> {
  const { apiUrl, useMock } = await getConfig()

  // 1. Modo mock o backend inexistente
  if (useMock || !apiUrl) {
    await delay(300)
    return [...mockPersonas]
  }

  const url = `${apiUrl}/consultar/clientes`

  let res: Response

  try {
    res = await fetch(url)
  } catch (e) {
    // Fallo de red, DNS, CORS, proxy muerto, etc.
    console.error('[API][getAll] Network error:', e)
    throw new Error('No se pudo conectar con el backend')
  }

  // 2. Status HTTP inválido
  if (!res.ok) {
    const text = await res.text()
    console.error('[API][getAll] HTTP error', res.status, text)
    throw new Error(`Error ${res.status} al consultar personas`)
  }

  // 3. Validar que realmente sea JSON
  const contentType = res.headers.get('content-type')

  if (!contentType || !contentType.includes('application/json')) {
    const text = await res.text()
    console.error('[API][getAll] Invalid content-type:', contentType, text)
    throw new Error('Respuesta inválida del servidor (no es JSON)')
  }

  // 4. Parse seguro
  try {
    const data = await res.json()

    // 5. Validación mínima del contrato
    if (!Array.isArray(data)) {
      console.error('[API][getAll] Payload inesperado:', data)
      throw new Error('Formato de respuesta inválido')
    }

    return data as Persona[]
  } catch (e) {
    console.error('[API][getAll] JSON parse error:', e)
    throw new Error('Error al procesar la respuesta del servidor')
  }
}
