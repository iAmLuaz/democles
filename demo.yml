import type { Persona } from "@/types/persona"
import { mockPersonas } from "@/mock/personas"

const USE_MOCK = false
const delay = (ms: number) => new Promise(res => setTimeout(res, ms))

const API_BASE =
  import.meta.env.VITE_PERSONAS_PROXY_URL ||
  'http://localhost:7071/api/personas-proxy'

export const personasService = {
  async getAll(): Promise<Persona[]> {
    if (USE_MOCK) {
      await delay(300)
      return [...mockPersonas]
    }
    const res = await fetch(API_BASE)
    return await res.json()
  },

  async getById(id: string): Promise<Persona | undefined> {
    if (USE_MOCK) {
      await delay(200)
      return mockPersonas.find(p => p.id === id)
    }
    const res = await fetch(`${API_BASE}?id=${id}`)
    return await res.json()
  },

  async create(data: Omit<Persona, 'id'>): Promise<Persona> {
    if (USE_MOCK) {
      await delay(300)
      const p: Persona = { ...data, id: crypto.randomUUID() }
      mockPersonas.push(p)
      return p
    }
    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    return await res.json()
  },

  async update(id: string, data: Partial<Persona>): Promise<Persona> {
    if (USE_MOCK) {
      await delay(300)
      const i = mockPersonas.findIndex(p => p.id === id)
      if (i === -1) throw new Error('No encontrada')
      mockPersonas[i] = { ...mockPersonas[i], ...data }
      return mockPersonas[i]
    }
    const res = await fetch(`${API_BASE}?id=${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    return await res.json()
  },

  async delete(id: string): Promise<void> {
    if (USE_MOCK) {
      await delay(200)
      const i = mockPersonas.findIndex(p => p.id === id)
      if (i !== -1) mockPersonas.splice(i, 1)
      return
    }
    await fetch(`${API_BASE}?id=${id}`, { method: 'DELETE' })
  }
}


module.exports = async function (context, req) {
  const API_URL = process.env.API_URL // üîê Key Vault
  const method = req.method.toUpperCase()
  const id = req.query?.id || null

  let url = null

  if (method === 'GET' && !id) url = `${API_URL}/consultar/clientes`
  if (method === 'GET' && id) url = `${API_URL}/consultar/cliente/${id}`
  if (method === 'POST') url = `${API_URL}/registrar/cliente`
  if (method === 'PUT' && id) url = `${API_URL}/actualizar/cliente/${id}`
  if (method === 'DELETE' && id) url = `${API_URL}/eliminar/cliente/${id}`

  if (!url) {
    context.res = { status: 400, body: 'Ruta no soportada' }
    return
  }

  const res = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: ['GET', 'DELETE'].includes(method) ? undefined : JSON.stringify(req.body)
  })

  context.res = {
    status: res.status,
    headers: {
      'Content-Type': res.headers.get('content-type') ?? 'application/json',
      'Access-Control-Allow-Origin': '*'
    },
    body: await res.text()
  }
}



