module.exports = async function (context, req) {
  console.log('üî• FUNCTION HIT')
  console.log('‚û°Ô∏è METHOD:', req.method)
  console.log('‚û°Ô∏è URL:', req.url)
  console.log('‚û°Ô∏è BODY:', req.body)
  console.log('‚û°Ô∏è BINDING ID:', context.bindingData?.id)

  const API_URL = process.env.API_URL
  console.log('‚û°Ô∏è API_URL:', API_URL)

  const method = req.method.toUpperCase()
  const id = context.bindingData.id

  let url = null

  if (method === 'GET' && !id) {
    url = `${API_URL}/consultar/clientes`
  }

  if (method === 'GET' && id) {
    url = `${API_URL}/consultar/cliente/${id}`
  }

  if (method === 'POST') {
    url = `${API_URL}/registrar/cliente`
  }

  if (method === 'PUT' && id) {
    url = `${API_URL}/actualizar/cliente/${id}`
  }

  if (method === 'DELETE' && id) {
    url = `${API_URL}/eliminar/cliente/${id}`
  }

  console.log('‚û°Ô∏è TARGET URL:', url)

  if (!url) {
    context.res = { status: 404, body: 'Ruta no soportada' }
    return
  }

  const res = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: ['GET', 'DELETE'].includes(method)
      ? undefined
      : JSON.stringify(req.body)
  })

  console.log('‚¨ÖÔ∏è BACKEND STATUS:', res.status)

  const data = await res.text()

  context.res = {
    status: res.status,
    headers: {
      'Content-Type': res.headers.get('content-type') ?? 'application/json',
      'Access-Control-Allow-Origin': '*'
    },
    body: data
  }
}
